<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Paul Hegedus" />


<title>Prepare Data</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ESA2020-Hegedus</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="introduction.html">Introduction</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Methods
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="methods.html">Overview</a>
    </li>
    <li>
      <a href="data_prep.html">Data Preparation</a>
    </li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Field Analysis</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="analysis_sec1.html">sec1</a>
        </li>
        <li>
          <a href="analysis_sec35middle.html">sec35middle</a>
        </li>
        <li>
          <a href="analysis_carlinwest.html">carlinwest</a>
        </li>
        <li>
          <a href="analysis_henrys.html">henrys</a>
        </li>
        <li>
          <a href="analysis_minnies.html">minnies</a>
        </li>
        <li>
          <a href="analysis_sre910.html">sre910</a>
        </li>
        <li>
          <a href="analysis_gramsmoms.html">gramsmoms</a>
        </li>
        <li>
          <a href="analysis_sre1314.html">sre1314</a>
        </li>
      </ul>
    </li>
    <li>
      <a href="esa_analysis.html">ESA Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="results.html">Results</a>
</li>
<li>
  <a href="discussion.html">Discussion</a>
</li>
<li>
  <a href="references.html">References</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Prepare Data</h1>
<h4 class="author">Paul Hegedus</h4>

</div>


<p>This section covers the preparation of data for this project’s analysis. See the methods overview <a href="methods.html">page</a> for a formal description of the methods used for this project and for more detail on the collection process of the data used in this project.</p>
<p>The data used in this project is from the On-Farm Precision Experiments project at Montana State University. The project aims to provide a decision aid tool for producers that allows them to simulate management outcomes under various economic and weather scenarios, using data driven solutions to address the uncertainty in the price and weather condition in the upcoming year. The OFPE project operates with the mindset that experimentation is critical to understanding the field specific response of crops to agricultural inputs and the environment.</p>
<p>For each field used in the OFPE project, nitrogen fertilizer rates are randomly stratified on previous yield, protein, and previously applied nitrogen rates when possible. The as-applied data is collected from each farmer’s fertilizer sprayer or spreader. Crop yield and quality are measured by instruments on the combine and are collected during harvest operations. Crop yield is collected by the combine yield monitor, standard in most modern combines, and quality is measured as grain protein percent. Protein is calculated by the CropScan 3300H infrared analyzer mounted on the combine. Yield data is collected ~3 seconds and protein data is collected ~10 seconds, resulting in datasets with unequal spatial resolutions.</p>
<p>Net-return is calculated as a function of yield, protein, the cost of nitrogen, and other fixed costs associated with producing the crop. In Montana, wheat producers receive a protein premium for grain protein content above a specified threshold, while a dockage is non-linearly imposed if grain protein content falls below the threshold.</p>
<p>In addition to data collected on-farms, open source remotely sensed data is gathered as covariates for developing models of crop yield, quality, and net-return. These include topographic variables such as elevation, slope, aspect, and topographic position index (TPI). Time bound covariates are collected from the year prior to the harvest year, and from January 1st to March 30th of the current year. This is because March 30th is the date at which farmers need to decide on their top-dress nitrogen fertilizer applications. Time bound covariates include weather data, such as precipitation and growing degree days, and vegetation index data, of which NDVI was used.</p>
<p>The data used in this project have already been aggregated together during the OFPE data cycle. See the <a href="https://paulhegedus.github.io/OFPE-Website/">OFPE Technical Website</a> for more information on this process. Yield and protein data that are less than 30m from the field edge are removed, as well as observations above or below 4 standard deviations from the field mean. A 10m grid is applied across each field and observed yield and protein data points that fall within each grid are assessed again as to whether they constitute as a local outlier and removed if so. The mean for each grid cell is calculated and assigned to the centroid of each cell. Aggregating to the centroids of a 10m grid is used to reduce the noise in the dataset due to machine and collection errors while retaining a fine spatial resolution. It also reduces the size of the dataset, improving analysis speeds.</p>
<p>The sections below describes the process of importing data, selecting the columns with covariate or response data we are interested in, exploring this data, and executing one more round of data cleaning and assessment. Protein data is interpolated to the location of yield data because the yield data is collected at a higher spatial resolution. Protein is interpolated using co-kriging with yield. Finally, the net-return for each point is calculated using a protein premium/dockage function, the cost of nitrogen, and the price received for non-organic winter wheat. The economic data used is from 2016, the most recent year that we have access to all three aspects of the net-return parameters that are not collected on-farms.</p>
<pre class="r"><code>library()</code></pre>
<div id="import-select-clean" class="section level2">
<h2>Import, Select, Clean</h2>
<p>This section shows the code used for importing data, selecting the variables of interest, executing a final clean, and saving exploratory plots. These are lumped together in order to save space in RAM by executing the functions for each field with only that field in memory.</p>
<p>For each file read in, the data type is assessed (yield vs. protein). The data used has multiple columns for the same metric due to different data sources. In all cases, the source with the finest spatial resolution is selected. The vegetation index used is NDVI, so other indexes like NDRE and CIRE are removed. The only cleaning step is removing as-applied nitrogen rates above 300 lbs N/ per acre because these rates are clear machine collection errors, as this is greater than if a double rate was applied during turning or by mistake.</p>
<p>The ‘raw’ data is imported one file at a time, and then saved as ‘clean’ data. This ‘clean’ data is then used for interpolation and calculation of net-return.</p>
</div>
<div id="interpolate-protein" class="section level2">
<h2>Interpolate Protein</h2>
<p>The discrepancy between the yield and protein spatial resolutions results in two datasets for each field per year. To calculate net-return and consolidate the data, protein is interpolated to the location of each yield point. Co-kriging is used for interpolation because it utilizes a relationship with a more densely sampled variable. In this case we are utilizing the relationship between yield and protein.</p>
</div>
<div id="calculate-net-return" class="section level2">
<h2>Calculate Net-Return</h2>
<p>Net-return is calculated for each point in the dataset. First, a model of premium/dockage is fit using 2016 data. Yield is multiplied by the price received per bushel for a base price received. The coefficients of the premium/dockage function are used with the interpolated protein data to calculate the increase/decrease from the base-price. The cost of nitrogen applied per point is calculated with the price per pound of nitrogen and subtracted from the base price. Finally the cost of all other expenses are subtracted for a final net-return for each point.</p>
</div>
<div id="explore-data" class="section level2">
<h2>Explore Data</h2>
<p>The code below runs funcitons that produce exploratory plots and maps of the data. These include plotting each covariate against yield, protein, and net-return as well as maps of as-applied nitrogen, yield, protein, and net-return.</p>
<p>The functions below use ‘prepped’ data for plotting and mapping. This data can be used to assess relationships between variables.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
